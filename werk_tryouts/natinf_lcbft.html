<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.336">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="description" content="Je souhaite traiter les données de manières différentes. J’ai trop pris mes aises avec le tidyverse, je souhaite dépasser cette pratique car je pense pouvoir être plus efficace, autrement.">
<title>Infractions LCB-FT</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="natinf_lcbft_files/libs/clipboard/clipboard.min.js"></script>
<script src="natinf_lcbft_files/libs/quarto-html/quarto.js"></script>
<script src="natinf_lcbft_files/libs/quarto-html/popper.min.js"></script>
<script src="natinf_lcbft_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="natinf_lcbft_files/libs/quarto-html/anchor.min.js"></script>
<link href="natinf_lcbft_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="natinf_lcbft_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="natinf_lcbft_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="natinf_lcbft_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="natinf_lcbft_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
</head>
<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table des matières</h2>
   
  <ul>
<li><a href="#contexte" id="toc-contexte" class="nav-link active" data-scroll-target="#contexte">Contexte</a></li>
  <li><a href="#objectifs" id="toc-objectifs" class="nav-link" data-scroll-target="#objectifs">Objectifs</a></li>
  <li>
<a href="#le-code" id="toc-le-code" class="nav-link" data-scroll-target="#le-code">Le code</a>
  <ul>
<li><a href="#appeler-les-packages" id="toc-appeler-les-packages" class="nav-link" data-scroll-target="#appeler-les-packages">Appeler les packages</a></li>
  <li><a href="#importer-les-donn%C3%A9es" id="toc-importer-les-données" class="nav-link" data-scroll-target="#importer-les-donn%C3%A9es">Importer les données</a></li>
  <li>
<a href="#quelques-statistiques-descriptives" id="toc-quelques-statistiques-descriptives" class="nav-link" data-scroll-target="#quelques-statistiques-descriptives">Quelques statistiques descriptives</a>
  <ul class="collapse">
<li><a href="#sur-la-table-et-ses-variables" id="toc-sur-la-table-et-ses-variables" class="nav-link" data-scroll-target="#sur-la-table-et-ses-variables">Sur la table et ses variables</a></li>
  <li><a href="#sur-le-contenu-des-variables" id="toc-sur-le-contenu-des-variables" class="nav-link" data-scroll-target="#sur-le-contenu-des-variables">Sur le contenu des variables</a></li>
  </ul>
</li>
  <li><a href="#nettoyage-et-recodage" id="toc-nettoyage-et-recodage" class="nav-link" data-scroll-target="#nettoyage-et-recodage">Nettoyage et recodage</a></li>
  </ul>
</li>
  <li><a href="#pistes-dam%C3%A9lioration" id="toc-pistes-damélioration" class="nav-link" data-scroll-target="#pistes-dam%C3%A9lioration">Pistes d’amélioration</a></li>
  </ul></nav>
</div>
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Infractions LCB-FT</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Revue de la performance, <code>dplyr</code> contre <code>base</code></p>
</div>

<div>
  <div class="description">
    Je souhaite traiter les données de manières différentes. J’ai trop pris mes aises avec le <code>tidyverse</code>, je souhaite dépasser cette pratique car je pense pouvoir être plus efficace, autrement.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Date de publication</div>
    <div class="quarto-title-meta-contents">
      <p class="date">23 avril 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header><section id="contexte" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="contexte">Contexte</h2>
<p>Dans le cadre du suivi de cohorte des affaires de lutte contre le blanchiment des capitaux et le financement du terrorisme (LCB-FT), je dois récupérer les affaires dont les infractions à l’enregistrement (à la saisine du parquet) sont dans le champ LCB-FT. Le Pepp a envoyé un fichier de natinfs que je trouve indigeste et pas pratique à manipuler quand je fais des jointures sur SASEG : pour répondre à mes besoins, je l’ai donc nettoyé à partir de R.</p>
<p>J’ai l’habitude d’utiliser les fonctions du <code>tidyverse</code> pour manipuler les données. Le <code>tidyverse</code> (et <code>dplyr</code> plus particulièrement) est simple à comprendre, c’est descriptif, c’est facile de visualiser les modifications qu’on fait puisque les fonctions s’enchaînent avec le pipe (<code>|&gt;</code> anciennement <code>%&gt;%</code>). Je n’ai pas besoin de faire des boucles, on a des fonctions toutes prêtes pour appliquer des modifications conditionnelles, comme <code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code>, ou les <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> de <code>purr</code>.</p>
<p>De plus, la syntaxe <code>dplyr</code> est semblable à la syntaxe SQL, ce qui m’a permis de prendre mes fonctions rapidement malgré ma méconnaissance de SAS et de SQL à mon arrivée.</p>
<div class="page-columns page-full"><p>Toutefois, je commence à comprendre que ces fonctions ne sont pas les plus performantes pour les bases de données volumineuses<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Le <code>tidyverse</code> est également très bavard, ce que je prends toujours en grippe. De ce que j’ai lu, c’est aussi plus instable car il s’agit d’un regroupement de packages qui s’appuient les uns sur les autres. C’est ainsi que j’ai découvert les bases de la manipulation des données avec <code>data.table</code>. Je souhaite aussi maintenir mes connaissances sur le <code>R</code> de base.</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;Ce qui est le cas à la SDSE, puisqu’on utilise des données administratives. Cassiopée est massif.</p></li></div></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Avertissement
</div>
</div>
<div class="callout-body-container callout-body">
<p>Je mentionne le package <code>data.table</code>, qui a l’air pas mal et qui est présenté comme la meilleure alternative pour les données volumineuses. J’ai commencé à lire la docu et des comparaisons entre ça et le <code>tidyverse</code>, je comprends le principe mais je n’arrive pas à appliquer/m’imaginer comment faire des trucs itératifs, comme “modifier le nom de toutes les colonnes avec <code><a href="https://sfirke.github.io/janitor/reference/clean_names.html">janitor::clean_names()</a></code>”, ou faire un <code>rowSums</code>.</p>
<p>Je me concentre donc plutôt sur le <code>base R</code>, surtout que je lis <a href="https://teaching.slmc.fr/perf/presentation_handout.pdf">des diapos de Martin Chevallier</a> dessus<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
</div>
</div>
<div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;Avec des <a href="https://teaching.slmc.fr/perf/">exercices</a>.</p></li></div></section><section id="objectifs" class="level2"><h2 class="anchored" data-anchor-id="objectifs">Objectifs</h2>
<ul>
<li>Reproduire le code que je fais d’habitude en <code>dplyr</code>, en <code>base</code>.</li>
<li>Comparer la performance entre les deux manières. Pour moi, la performance se repose sur la rapidité et la propreté du code.</li>
<li>Expliquer mon script, pour ne pas oublier ce que j’ai fait !</li>
<li>Utiliser <a href="https://quarto.org/">quarto</a> :)</li>
</ul></section><section id="le-code" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="le-code">Le code</h2>
<section id="appeler-les-packages" class="level3"><h3 class="anchored" data-anchor-id="appeler-les-packages">Appeler les packages</h3>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/">microbenchmark</a></span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="importer-les-données" class="level3"><h3 class="anchored" data-anchor-id="importer-les-données">Importer les données</h3>
<p>Il s’agit donc du fichier natinfs du Pepp qui contient toutes les infractions existantes, et qui les qualifient avec des variables dichotomiques en “oui/non” si elles appartiennent à un ou plusieurs groupes du contentieux LCB-FT.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Les contentieux LCB-FT">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Les contentieux LCB-FT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Les groupes sont les suivants :</p>
<ul>
<li>Blanchiment,</li>
<li>Trafic de stupéfiants,</li>
<li>Fraude fiscale, sociale ou douanière,</li>
<li>Vol et escroquerie,</li>
<li>Traite des êtres humains,</li>
<li>Atteinte à la probité,</li>
<li>Recel,</li>
<li>Non-justification des ressources,</li>
<li>Financement du terrorisme.</li>
</ul>
</div>
</div>
</div>
<p>Le fichier de base contient des variables sur la NATAFF, les textes réprimants, les encourus, etc. J’ai retiré tout ça du fichier Excel que j’importe dans ma session R. Je mets les noms de variables en minuscule pour faciliter les manips, d’un côté avec <code><a href="https://stringr.tidyverse.org/reference/case.html">stringr::str_to_lower()</a></code> et de l’autre avec <code><a href="https://rdrr.io/r/base/chartr.html">base::tolower()</a></code>, R étant sensible à la casse tandis que SAS/SQL ne l’est pas.</p>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<section id="dplyr" class="level4 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h4 class="anchored" data-anchor-id="dplyr"><code>dplyr</code></h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span><span class="st">"natinf.xlsx"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="base" class="level4 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h4 class="anchored" data-anchor-id="base"><code>base</code></h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span><span class="st">"natinf.xlsx"</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
<p>La différence de temps d’exécution entre les deux manières est négligeable, <code>base</code> serait même plus lent.</p>
<p>Je préfère la syntaxe d’importation avec <code>dplyr</code>, quoique je n’utilise pas une de ses fonctions d’importation comme <code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">import_base</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span><span class="st">"natinf.xlsx"</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  times <span class="op">=</span> <span class="fl">50L</span>,</span>
<span>  import_dplyr <span class="op">=</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span><span class="st">"natinf.xlsx"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>  import_base <span class="op">=</span> <span class="fu">import_base</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 17%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 8%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">expr</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">lq</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">uq</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">neval</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">import_dplyr</td>
<td style="text-align: right;">214.6928</td>
<td style="text-align: right;">235.0671</td>
<td style="text-align: right;">291.1153</td>
<td style="text-align: right;">256.9296</td>
<td style="text-align: right;">320.8785</td>
<td style="text-align: right;">515.0297</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">import_base</td>
<td style="text-align: right;">210.6738</td>
<td style="text-align: right;">236.6157</td>
<td style="text-align: right;">295.6295</td>
<td style="text-align: right;">256.8566</td>
<td style="text-align: right;">366.3144</td>
<td style="text-align: right;">488.3878</td>
<td style="text-align: right;">50</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Importation - à l'avenir">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Importation - à l’avenir
</div>
</div>
<div class="callout-body-container callout-body">
<p>Vérifier qu’il n’y a pas une option de nettoyage de nom directement dans une fonction.</p>
</div>
</div>
</section><section id="quelques-statistiques-descriptives" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="quelques-statistiques-descriptives">Quelques statistiques descriptives</h3>
<section id="sur-la-table-et-ses-variables" class="level4"><h4 class="anchored" data-anchor-id="sur-la-table-et-ses-variables">Sur la table et ses variables</h4>
<p>Mes commandes de bases pour une vérification rapide de l’objet.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># info table</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="co"># type de table</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="co"># noms des colonnes de la table</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="co"># nombre de lignes et de colonnes</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pour déterminer le nombre de valeurs distinctes par variable et le type de chaque variable.</p>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<section id="dplyr-1" class="level5 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h5 class="anchored" data-anchor-id="dplyr-1"><code>dplyr</code></h5>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">n_distinct</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="base-1" class="level5 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h5 class="anchored" data-anchor-id="base-1"><code>base</code></h5>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">n_distinct</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">class</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
<p>L’analyse de performance lance ces quatre commandes 50 fois : elle montre que les fonctions de base sont plus rapides, notamment pour déterminer le type de variable. Je suspecte que le faible écart pour <code>n_distinct</code> s’explique par le fait qu’il s’agit d’une fonction de <code>dplyr</code> que j’utilise dans les deux cas.</p>
<p>La documentation de la fonction (<code><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">dplyr::n_distinct()</a></code>) indique d’ailleurs qu’elle serait plus rapide que la manipulation en <code>base</code>, avec la commande <code>nrow(unique(data.frame(...)))</code>, je ne sais donc pas s’il existe une meilleure alternative.</p>
<p>Je n’ai pas de préférence entre les deux, ce sont des commandes simples. <code>sapply</code> présente tout de même l’avantage de ne pas changer de nom selon l’entrée/sortie de données, concept que j’ai toujours du mal à saisir avec les fonctions <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  times <span class="op">=</span> <span class="fl">50L</span>,</span>
<span>  dplyr_nd <span class="op">=</span> <span class="va">n</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">n_distinct</span><span class="op">)</span>,</span>
<span>  base_nd  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">n_distinct</span><span class="op">)</span>,</span>
<span>  dplyr_class <span class="op">=</span> <span class="va">n</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span>,</span>
<span>  base_class  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">class</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 18%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 12%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 9%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">expr</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">lq</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">uq</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">neval</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">dplyr_nd</td>
<td style="text-align: right;">2473.3</td>
<td style="text-align: right;">2690.7</td>
<td style="text-align: right;">3072.238</td>
<td style="text-align: right;">2762.80</td>
<td style="text-align: right;">3000.9</td>
<td style="text-align: right;">10677.3</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">base_nd</td>
<td style="text-align: right;">2543.7</td>
<td style="text-align: right;">2672.9</td>
<td style="text-align: right;">3149.806</td>
<td style="text-align: right;">2754.15</td>
<td style="text-align: right;">3075.4</td>
<td style="text-align: right;">7537.6</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dplyr_class</td>
<td style="text-align: right;">278.2</td>
<td style="text-align: right;">348.4</td>
<td style="text-align: right;">481.406</td>
<td style="text-align: right;">480.90</td>
<td style="text-align: right;">560.1</td>
<td style="text-align: right;">1498.7</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">base_class</td>
<td style="text-align: right;">22.9</td>
<td style="text-align: right;">31.5</td>
<td style="text-align: right;">44.242</td>
<td style="text-align: right;">40.25</td>
<td style="text-align: right;">53.2</td>
<td style="text-align: right;">95.5</td>
<td style="text-align: right;">50</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="La prochaine fois">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
La prochaine fois
</div>
</div>
<div class="callout-body-container callout-body">
<p>Créer une fonction qui regroupe directement toutes mes commandes de base ? Ça risque d’impliquer la création d’un package, à méditer.</p>
</div>
</div>
</section><section id="sur-le-contenu-des-variables" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="sur-le-contenu-des-variables">Sur le contenu des variables</h4>
<p>Pour obtenir le nombre d’infractions par type de contentieux/d’infractions sous-jacentes.</p>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<section id="dplyr-2" class="level5 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h5 class="anchored" data-anchor-id="dplyr-2"><code>dplyr</code></h5>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">natinf</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.x</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="co"># ou</span></span>
<span><span class="va">n</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">natinf</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">table</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="base-2" class="level5 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h5 class="anchored" data-anchor-id="base-2"><code>base</code></h5>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">table</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">table</span><span class="op">)</span> <span class="co"># pour un tableau par colonne</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
<div class="page-columns page-full"><p>Ce ne sont pas les commandes les plus complexes, mais on voit clairement la différence de longueur entre les deux. Avec <code>dplyr</code>, je dois bien spécifier que je ne veux pas avoir de tableau pour la variable <code>natinf</code> en l’enlevant temporairement du jeu de données, tandis qu’en base, je peux simplement indexé les données<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> en retirant la première colonne, qui correspond à celles des natinfs.</p><div class="no-row-height column-margin column-container"><li id="fn3"><p><sup>3</sup>&nbsp;Pour rappel, <code>df[i,j]</code> pour <code>i</code> = les lignes et <code>j</code> = les colonnes.</p></li></div></div>
<p>La première méthode avec <code>dplyr</code>, inspirée de mon habitude de faire <code>df |&gt; count(x)</code> se débrouille le moins bien.</p>
<p>Si ce sont des variables qui ont les mêmes modalités, je vois l’intérêt d’utiliser <code><a href="https://rdrr.io/r/base/lapply.html">sapply()</a></code> en particulier, puisque tout est rassemblé dans une matrice avec les modalités en ligne (oui/non) et les contentieux en colonne.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  times <span class="op">=</span> <span class="fl">50L</span>,</span>
<span>  dplyr_1 <span class="op">=</span> <span class="va">n</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">natinf</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.x</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  dplyr_2 <span class="op">=</span> <span class="va">n</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">natinf</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">table</span><span class="op">)</span>,</span>
<span>  base <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">table</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 15%">
<col style="width: 13%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 9%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">expr</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">lq</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">uq</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">neval</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">dplyr_1</td>
<td style="text-align: right;">41.0222</td>
<td style="text-align: right;">42.1670</td>
<td style="text-align: right;">44.437166</td>
<td style="text-align: right;">43.23555</td>
<td style="text-align: right;">46.7456</td>
<td style="text-align: right;">51.0864</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">dplyr_2</td>
<td style="text-align: right;">9.5330</td>
<td style="text-align: right;">9.9708</td>
<td style="text-align: right;">11.320258</td>
<td style="text-align: right;">10.29730</td>
<td style="text-align: right;">13.0663</td>
<td style="text-align: right;">16.9414</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="odd">
<td style="text-align: left;">base</td>
<td style="text-align: right;">8.0492</td>
<td style="text-align: right;">8.5194</td>
<td style="text-align: right;">9.984568</td>
<td style="text-align: right;">8.76075</td>
<td style="text-align: right;">11.4243</td>
<td style="text-align: right;">21.9574</td>
<td style="text-align: right;">50</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section></section><section id="nettoyage-et-recodage" class="level3"><h3 class="anchored" data-anchor-id="nettoyage-et-recodage">Nettoyage et recodage</h3>
<p>J’ai les informations qu’il me faut sur la base inchangée, maintenant je la transforme pour l’exportation finale et l’importation sur SASEG.</p>
<p>Je change les modalités de groupes, initialement en oui/non, pour avoir des variables binaires.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># on change les chaines de caractères "oui/non" en binaire 0/1</span></span>
<span><span class="va">n_rec</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.character</span><span class="op">)</span>,</span>
<span>      <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">.</span> <span class="op">==</span> <span class="st">"oui"</span> <span class="op">~</span> <span class="fl">1</span>, <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Trouver comment faire ça en <code>base</code> !!!</p>
</div>
</div>
<p>Je vérifie que les effectifs sont les mêmes que pré-recodage. Maintenant que ce sont des variables binaires, je peux simplement faire la somme des colonnes pour avoir le nombre d’infractions de chaque groupe.</p>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<section id="dplyr-3" class="level4 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h4 class="anchored" data-anchor-id="dplyr-3"><code>dplyr</code></h4>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n_rec</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">natinf</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">table</span><span class="op">)</span></span>
<span><span class="va">n_rec</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">natinf</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">sum</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ou :)</span></span>
<span></span>
<span><span class="va">n_rec</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">stup</span><span class="op">:</span><span class="va">fiter</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"contentieux"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"nb_inf"</span></span>
<span>    <span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="base-3" class="level4 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h4 class="anchored" data-anchor-id="base-3"><code>base</code></h4>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ou encore</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sum</span><span class="op">)</span> <span class="co"># ...nettement moins bavard...</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
<p>Je veux maintenant faire la somme <strong>par ligne</strong> (donc par infraction) des contentieux, pour voir si certaines infractions appartiennent à plus d’un groupe LCB-FT.</p>
<p>J’ai d’abord utilisé la fonction <code><a href="https://dplyr.tidyverse.org/reference/c_across.html">dplyr::c_across</a></code> pour faire cette opération, après la commande <code><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise()</a></code> qui agit un peu comme <code>group_by</code> (d’où la nécessité de dégrouper à la fin, sinon toutes les opérations qui suivent se feront par ligne). Ça fonctionne, mais le temps d’exécution est énorme.</p>
<p>La solution (comme prônée sur <a href="https://dplyr.tidyverse.org/articles/rowwise.html">cette vignette</a> du package) est plutôt d’utiliser une fonction déjà programmée qui fait exactement ce que je veux, de base. C’est le cas de <code><a href="https://rdrr.io/r/base/colSums.html">base::rowSums()</a></code> que j’ai donc fait passer dans <code>mutate</code>, en spécifiant que je ne voulais pas prendre en compte la variable de natinf.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Seconde tentative - rapide</a></li>
<li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Première tentative - lent</a></li>
</ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># infractions qui appartiendraient à plusieurs groupes de sous-jacent?</span></span>
<span><span class="va">n_rec</span> <span class="op">&lt;-</span> <span class="va">n_rec</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_sj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pick.html">pick</a></span><span class="op">(</span><span class="op">-</span><span class="va">natinf</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n_rec</span> <span class="op">&lt;-</span> <span class="va">n_rec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_sj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across</a></span><span class="op">(</span><span class="va">stup</span><span class="op">:</span><span class="va">fiter</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ungroup</span></span>
<span>  <span class="co"># très lent</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<section id="dplyr-4" class="level4 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h4 class="anchored" data-anchor-id="dplyr-4"><code>dplyr</code></h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">n_rec</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_sj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across</a></span><span class="op">(</span><span class="va">stup</span><span class="op">:</span><span class="va">fiter</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">n_sj</span><span class="op">)</span> <span class="co"># LENT!</span></span>
<span></span>
<span><span class="co"># ou plutôt</span></span>
<span><span class="va">n_rec</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n_sj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pick.html">pick</a></span><span class="op">(</span><span class="op">-</span><span class="va">natinf</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">n_sj</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="base-4" class="level4 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h4 class="anchored" data-anchor-id="base-4"><code>base</code></h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># quelle est cette natinf qui appartient à trois groupes?</span></span>
<span><span class="va">n_rec</span><span class="op">[</span><span class="va">n_rec</span><span class="op">$</span><span class="va">n_sj</span><span class="op">==</span><span class="fl">3</span>,<span class="op">]</span></span>
<span><span class="va">n_rec</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">==</span><span class="fl">3</span>,<span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="co"># 20307: REALISATION D'UNE OPERATION FINANCIERE ENTRE LA FRANCE ET L'ETRANGER SUR DES FONDS PROVENANT D'INFRACTION A LA LEGISLATION SUR LES STUPEFIANTS : BLANCHIMENT DOUANIER</span></span>
<span>  <span class="co"># stup, ffsd, blanchiment</span></span>
<span></span>
<span><span class="co"># combien d'infractions distinctes qui sont bien du blanchiment, et sous-jacent?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">[</span><span class="va">n_rec</span><span class="op">$</span><span class="va">n_sj</span><span class="op">&gt;</span><span class="fl">0</span>,<span class="op">]</span><span class="op">)</span> <span class="co"># 1728</span></span>
<span></span>
<span>  <span class="co"># en data.table - clairement moins rapide</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">)</span><span class="op">[</span><span class="va">n_sj</span><span class="op">&gt;</span><span class="fl">0</span>,<span class="va">.N</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># infractions BLANCHIMENT </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">[</span><span class="va">n_rec</span><span class="op">$</span><span class="va">blanchiment</span><span class="op">==</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span> <span class="co"># 75 de blanchiment</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">[</span><span class="va">n_rec</span><span class="op">$</span><span class="va">blanchiment</span><span class="op">==</span><span class="fl">1</span> <span class="op">&amp;</span> <span class="va">n_rec</span><span class="op">$</span><span class="va">n_sj</span><span class="op">==</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span> <span class="co"># 27 caractérisées comme QUE du blanchiment</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<section id="dplyr-5" class="level4 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h4 class="anchored" data-anchor-id="dplyr-5"><code>dplyr</code></h4>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># contentieux et uniquement ce contentieux</span></span>
<span><span class="va">n_rec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n_sj</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">stup</span><span class="op">:</span><span class="va">fiter</span>,<span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"contentieux"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"nb_inf"</span></span>
<span>    <span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="base-5" class="level4 cell quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;"><h4 class="anchored" data-anchor-id="base-5"><code>base</code></h4>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">[</span><span class="va">n_rec</span><span class="op">$</span><span class="va">n_sj</span><span class="op">==</span><span class="fl">1</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,<span class="va">sum</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  times <span class="op">=</span> <span class="fl">50L</span>,</span>
<span>  dplyr <span class="op">=</span> <span class="va">n_rec</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n_sj</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">stup</span><span class="op">:</span><span class="va">fiter</span>,<span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,names_to<span class="op">=</span><span class="st">"contentieux"</span>,values_to<span class="op">=</span><span class="st">"nb_inf"</span><span class="op">)</span>,</span>
<span>  base <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">[</span><span class="va">n_rec</span><span class="op">$</span><span class="va">n_sj</span> <span class="op">==</span> <span class="fl">1</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">n_rec</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,<span class="va">sum</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="kable-table">
<table class="table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">expr</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">lq</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">uq</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">neval</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">dplyr</td>
<td style="text-align: right;">7009.0</td>
<td style="text-align: right;">7149.1</td>
<td style="text-align: right;">7572.988</td>
<td style="text-align: right;">7236.60</td>
<td style="text-align: right;">7393.0</td>
<td style="text-align: right;">13206.6</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">base</td>
<td style="text-align: right;">263.9</td>
<td style="text-align: right;">281.2</td>
<td style="text-align: right;">322.788</td>
<td style="text-align: right;">329.55</td>
<td style="text-align: right;">355.1</td>
<td style="text-align: right;">379.0</td>
<td style="text-align: right;">50</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section></section><section id="pistes-damélioration" class="level2"><h2 class="anchored" data-anchor-id="pistes-damélioration">Pistes d’amélioration</h2>
<!-- -->

</section></main><!-- /main column --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copié");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copié");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Code source</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb23" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Infractions LCB-FT"</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Revue de la performance, `dplyr` contre `base`"</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "Je souhaite traiter les données de manières différentes. J'ai trop pris mes aises avec le `tidyverse`, je souhaite dépasser cette pratique car je pense pouvoir être plus efficace, autrement."</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2023-04-23</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="an">lang:</span><span class="co"> fr</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 4</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">    # theme: </span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">    #   light: flatly</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">    #   dark: darkly</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: kable</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: a11y</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="an">reference-location:</span><span class="co"> margin</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="an">citation-location:</span><span class="co"> margin</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="fu">## Contexte</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>Dans le cadre du suivi de cohorte des affaires de lutte contre le blanchiment des capitaux et le financement du terrorisme (LCB-FT), je dois récupérer les affaires dont les infractions à l'enregistrement (à la saisine du parquet) sont dans le champ LCB-FT. Le Pepp a envoyé un fichier de natinfs que je trouve indigeste et pas pratique à manipuler quand je fais des jointures sur SASEG : pour répondre à mes besoins, je l'ai donc nettoyé à partir de R.</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>J'ai l'habitude d'utiliser les fonctions du <span class="in">`tidyverse`</span> pour manipuler les données. Le <span class="in">`tidyverse`</span> (et <span class="in">`dplyr`</span> plus particulièrement) est simple à comprendre, c'est descriptif, c'est facile de visualiser les modifications qu'on fait puisque les fonctions s'enchaînent avec le pipe (<span class="in">` |&gt; `</span> anciennement <span class="in">`%&gt;%`</span>). Je n'ai pas besoin de faire des boucles, on a des fonctions toutes prêtes pour appliquer des modifications conditionnelles, comme <span class="in">`across()`</span>, ou les <span class="in">`map()`</span> de <span class="in">`purr`</span>. </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>De plus, la syntaxe <span class="in">`dplyr`</span> est semblable à la syntaxe SQL, ce qui m'a permis de prendre mes fonctions rapidement malgré ma méconnaissance de SAS et de SQL à mon arrivée. </span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>Toutefois, je commence à comprendre que ces fonctions ne sont pas les plus performantes pour les bases de données volumineuses^<span class="co">[</span><span class="ot">Ce qui est le cas à la SDSE, puisqu'on utilise des données administratives. Cassiopée est massif.</span><span class="co">]</span>. Le <span class="in">`tidyverse`</span> est également très bavard, ce que je prends toujours en grippe. De ce que j'ai lu, c'est aussi plus instable car il s'agit d'un regroupement de packages qui s'appuient les uns sur les autres. C'est ainsi que j'ai découvert les bases de la manipulation des données avec <span class="in">`data.table`</span>. Je souhaite aussi maintenir mes connaissances sur le <span class="in">`R`</span> de base.</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>Je mentionne le package <span class="in">`data.table`</span>, qui a l'air pas mal et qui est présenté comme la meilleure alternative pour les données volumineuses. J'ai commencé à lire la docu et des comparaisons entre ça et le <span class="in">`tidyverse`</span>, je comprends le principe mais je n'arrive pas à appliquer/m'imaginer comment faire des trucs itératifs, comme "modifier le nom de toutes les colonnes avec <span class="in">`janitor::clean_names()`</span>", ou faire un <span class="in">`rowSums`</span>.</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>Je me concentre donc plutôt sur le <span class="in">`base R`</span>, surtout que je lis <span class="co">[</span><span class="ot">des diapos de Martin Chevallier</span><span class="co">](https://teaching.slmc.fr/perf/presentation_handout.pdf)</span> dessus^<span class="co">[</span><span class="ot">Avec des [exercices](https://teaching.slmc.fr/perf/).</span><span class="co">]</span>.</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="fu">## Objectifs</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Reproduire le code que je fais d'habitude en <span class="in">`dplyr`</span>, en <span class="in">`base`</span>.</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Comparer la performance entre les deux manières. Pour moi, la performance se repose sur la rapidité et la propreté du code. </span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Expliquer mon script, pour ne pas oublier ce que j'ai fait !</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Utiliser <span class="co">[</span><span class="ot">quarto</span><span class="co">](https://quarto.org/)</span> :)</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a><span class="fu">## Le code</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a><span class="fu">### Appeler les packages</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a><span class="fu">### Importer les données</span></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>Il s'agit donc du fichier natinfs du Pepp qui contient toutes les infractions existantes, et qui les qualifient avec des variables dichotomiques en "oui/non" si elles appartiennent à un ou plusieurs groupes du contentieux LCB-FT.</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true" title="Les contentieux LCB-FT"}</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>Les groupes sont les suivants :</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Blanchiment,</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Trafic de stupéfiants,</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Fraude fiscale, sociale ou douanière,</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Vol et escroquerie,</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Traite des êtres humains,</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Atteinte à la probité,</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Recel,</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Non-justification des ressources,</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Financement du terrorisme.</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>Le fichier de base contient des variables sur la NATAFF, les textes réprimants, les encourus, etc. J'ai retiré tout ça du fichier Excel que j'importe dans ma session R. Je mets les noms de variables en minuscule pour faciliter les manips, d'un côté avec <span class="in">`stringr::str_to_lower()`</span> et de l'autre avec <span class="in">`base::tolower()`</span>, R étant sensible à la casse tandis que SAS/SQL ne l'est pas.</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>::: {layout-ncol="2"}</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `dplyr`</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-dplyr</span></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">"natinf.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(</span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span><span class="fu">str_to_lower</span>(.), </span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">everything</span>()</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `base`</span></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-base</span></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">"natinf.xlsx"</span>) </span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(n) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(n)) </span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>La différence de temps d'exécution entre les deux manières est négligeable, <span class="in">`base`</span> serait même plus lent.</span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>Je préfère la syntaxe d'importation avec <span class="in">`dplyr`</span>, quoique je n'utilise pas une de ses fonctions d'importation comme <span class="in">`read_csv()`</span>.</span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>import_base <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">"natinf.xlsx"</span>) </span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(n) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">names</span>(n)) </span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">microbenchmark</span>(</span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> 50L,</span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>  <span class="at">import_dplyr =</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="st">"natinf.xlsx"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(</span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span><span class="fu">str_to_lower</span>(.), </span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">everything</span>()</span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">import_base =</span> <span class="fu">import_base</span>()</span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="Importation - à l'avenir"}</span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>Vérifier qu'il n'y a pas une option de nettoyage de nom directement dans une fonction.</span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a><span class="fu">### Quelques statistiques descriptives</span></span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Sur la table et ses variables</span></span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>Mes commandes de bases pour une vérification rapide de l'objet.</span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: stat-desc</span></span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a><span class="co"># info table</span></span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(n) <span class="co"># type de table</span></span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(n) <span class="co"># noms des colonnes de la table</span></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(n) <span class="co"># nombre de lignes et de colonnes</span></span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a>Pour déterminer le nombre de valeurs distinctes par variable et le type de chaque variable.</span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a>::: {layout-ncol="2"}</span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a><span class="fu">##### `dplyr`</span></span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a>n <span class="sc">|&gt;</span> <span class="fu">map_dbl</span>(n_distinct)</span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a>n <span class="sc">|&gt;</span> <span class="fu">map_chr</span>(class)</span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a><span class="fu">##### `base`</span></span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(n, n_distinct)</span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(n, class)</span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a>L'analyse de performance lance ces quatre commandes 50 fois : elle montre que les fonctions de base sont plus rapides, notamment pour déterminer le type de variable. Je suspecte que le faible écart pour <span class="in">`n_distinct`</span> s'explique par le fait qu'il s'agit d'une fonction de <span class="in">`dplyr`</span> que j'utilise dans les deux cas. </span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a>La documentation de la fonction (<span class="in">`dplyr::n_distinct()`</span>) indique d'ailleurs qu'elle serait plus rapide que la manipulation en <span class="in">`base`</span>, avec la commande <span class="in">`nrow(unique(data.frame(...)))`</span>, je ne sais donc pas s'il existe une meilleure alternative.</span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a>Je n'ai pas de préférence entre les deux, ce sont des commandes simples. <span class="in">`sapply`</span> présente tout de même l'avantage de ne pas changer de nom selon l'entrée/sortie de données, concept que j'ai toujours du mal à saisir avec les fonctions <span class="in">`purrr::map()`</span>.</span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">microbenchmark</span>(</span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> 50L,</span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_nd =</span> n <span class="sc">|&gt;</span> <span class="fu">map_dbl</span>(n_distinct),</span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a>  <span class="at">base_nd  =</span> <span class="fu">sapply</span>(n, n_distinct),</span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_class =</span> n <span class="sc">|&gt;</span> <span class="fu">map_chr</span>(class),</span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a>  <span class="at">base_class  =</span> <span class="fu">sapply</span>(n, class)</span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="La prochaine fois"}</span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a>Créer une fonction qui regroupe directement toutes mes commandes de base ? Ça risque d'impliquer la création d'un package, à méditer.</span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Sur le contenu des variables</span></span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a>Pour obtenir le nombre d'infractions par type de contentieux/d'infractions sous-jacentes.</span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a>::: {layout-ncol="2"}</span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a><span class="fu">##### `dplyr`</span></span>
<span id="cb23-210"><a href="#cb23-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-211"><a href="#cb23-211" aria-hidden="true" tabindex="-1"></a>n <span class="sc">|&gt;</span>  </span>
<span id="cb23-212"><a href="#cb23-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>natinf) <span class="sc">|&gt;</span> </span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span><span class="fu">count</span>(<span class="fu">data.frame</span>(<span class="at">x =</span> .x), x)) </span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ou</span></span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a>n <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>natinf) <span class="sc">|&gt;</span> <span class="fu">map</span>(table)</span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a><span class="fu">##### `base`</span></span>
<span id="cb23-221"><a href="#cb23-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(n[<span class="sc">-</span><span class="dv">1</span>], table) </span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(n[<span class="sc">-</span><span class="dv">1</span>], table) <span class="co"># pour un tableau par colonne</span></span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-227"><a href="#cb23-227" aria-hidden="true" tabindex="-1"></a>Ce ne sont pas les commandes les plus complexes, mais on voit clairement la différence de longueur entre les deux. Avec <span class="in">`dplyr`</span>, je dois bien spécifier que je ne veux pas avoir de tableau pour la variable <span class="in">`natinf`</span> en l'enlevant temporairement du jeu de données, tandis qu'en base, je peux simplement indexé les données^<span class="co">[</span><span class="ot">Pour rappel, `df[i,j]` pour `i` = les lignes et `j` = les colonnes.</span><span class="co">]</span> en retirant la première colonne, qui correspond à celles des natinfs.</span>
<span id="cb23-228"><a href="#cb23-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a>La première méthode avec <span class="in">`dplyr`</span>, inspirée de mon habitude de faire <span class="in">`df |&gt; count(x)`</span> se débrouille le moins bien.</span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a>Si ce sont des variables qui ont les mêmes modalités, je vois l'intérêt d'utiliser <span class="in">`sapply()`</span> en particulier, puisque tout est rassemblé dans une matrice avec les modalités en ligne (oui/non) et les contentieux en colonne.</span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-235"><a href="#cb23-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">microbenchmark</span>(</span>
<span id="cb23-239"><a href="#cb23-239" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> 50L,</span>
<span id="cb23-240"><a href="#cb23-240" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_1 =</span> n <span class="sc">|&gt;</span>  <span class="fu">select</span>(<span class="sc">-</span>natinf) <span class="sc">|&gt;</span> <span class="fu">map</span>(<span class="sc">~</span><span class="fu">count</span>(<span class="fu">data.frame</span>(<span class="at">x =</span> .x), x)),</span>
<span id="cb23-241"><a href="#cb23-241" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_2 =</span> n <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>natinf) <span class="sc">|&gt;</span> <span class="fu">map</span>(table),</span>
<span id="cb23-242"><a href="#cb23-242" aria-hidden="true" tabindex="-1"></a>  <span class="at">base =</span> <span class="fu">sapply</span>(n[<span class="sc">-</span><span class="dv">1</span>], table)</span>
<span id="cb23-243"><a href="#cb23-243" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb23-244"><a href="#cb23-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-245"><a href="#cb23-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-246"><a href="#cb23-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-247"><a href="#cb23-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-248"><a href="#cb23-248" aria-hidden="true" tabindex="-1"></a><span class="fu">### Nettoyage et recodage</span></span>
<span id="cb23-249"><a href="#cb23-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-250"><a href="#cb23-250" aria-hidden="true" tabindex="-1"></a>J'ai les informations qu'il me faut sur la base inchangée, maintenant je la transforme pour l'exportation finale et l'importation sur SASEG.</span>
<span id="cb23-251"><a href="#cb23-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-252"><a href="#cb23-252" aria-hidden="true" tabindex="-1"></a>Je change les modalités de groupes, initialement en oui/non, pour avoir des variables binaires.</span>
<span id="cb23-253"><a href="#cb23-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-256"><a href="#cb23-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-257"><a href="#cb23-257" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-258"><a href="#cb23-258" aria-hidden="true" tabindex="-1"></a><span class="co"># on change les chaines de caractères "oui/non" en binaire 0/1</span></span>
<span id="cb23-259"><a href="#cb23-259" aria-hidden="true" tabindex="-1"></a>n_rec <span class="ot">&lt;-</span> n <span class="sc">|&gt;</span> </span>
<span id="cb23-260"><a href="#cb23-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-261"><a href="#cb23-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb23-262"><a href="#cb23-262" aria-hidden="true" tabindex="-1"></a>      <span class="fu">where</span>(is.character),</span>
<span id="cb23-263"><a href="#cb23-263" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">case_when</span>(. <span class="sc">==</span> <span class="st">"oui"</span> <span class="sc">~</span> <span class="dv">1</span>, <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span>)</span>
<span id="cb23-264"><a href="#cb23-264" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb23-265"><a href="#cb23-265" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-266"><a href="#cb23-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-267"><a href="#cb23-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-268"><a href="#cb23-268" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb23-269"><a href="#cb23-269" aria-hidden="true" tabindex="-1"></a>Trouver comment faire ça en <span class="in">`base`</span> !!!</span>
<span id="cb23-270"><a href="#cb23-270" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-271"><a href="#cb23-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-272"><a href="#cb23-272" aria-hidden="true" tabindex="-1"></a>Je vérifie que les effectifs sont les mêmes que pré-recodage. Maintenant que ce sont des variables binaires, je peux simplement faire la somme des colonnes pour avoir le nombre d'infractions de chaque groupe.</span>
<span id="cb23-273"><a href="#cb23-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-274"><a href="#cb23-274" aria-hidden="true" tabindex="-1"></a>::: {layout-ncol="2"}</span>
<span id="cb23-275"><a href="#cb23-275" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `dplyr`</span></span>
<span id="cb23-278"><a href="#cb23-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-279"><a href="#cb23-279" aria-hidden="true" tabindex="-1"></a>n_rec <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>natinf) <span class="sc">|&gt;</span> <span class="fu">map</span>(table)</span>
<span id="cb23-280"><a href="#cb23-280" aria-hidden="true" tabindex="-1"></a>n_rec <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>natinf) <span class="sc">|&gt;</span> <span class="fu">map_dbl</span>(sum)</span>
<span id="cb23-281"><a href="#cb23-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-282"><a href="#cb23-282" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ou :)</span></span>
<span id="cb23-283"><a href="#cb23-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-284"><a href="#cb23-284" aria-hidden="true" tabindex="-1"></a>n_rec <span class="sc">|&gt;</span> </span>
<span id="cb23-285"><a href="#cb23-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(stup<span class="sc">:</span>fiter, sum)) <span class="sc">|&gt;</span> </span>
<span id="cb23-286"><a href="#cb23-286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb23-287"><a href="#cb23-287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">everything</span>(),</span>
<span id="cb23-288"><a href="#cb23-288" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"contentieux"</span>,</span>
<span id="cb23-289"><a href="#cb23-289" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"nb_inf"</span></span>
<span id="cb23-290"><a href="#cb23-290" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-291"><a href="#cb23-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-292"><a href="#cb23-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-293"><a href="#cb23-293" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `base`</span></span>
<span id="cb23-296"><a href="#cb23-296" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-297"><a href="#cb23-297" aria-hidden="true" tabindex="-1"></a><span class="co"># ou encore</span></span>
<span id="cb23-298"><a href="#cb23-298" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(n_rec[<span class="sc">-</span><span class="dv">1</span>], sum) <span class="co"># ...nettement moins bavard...</span></span>
<span id="cb23-299"><a href="#cb23-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-300"><a href="#cb23-300" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-301"><a href="#cb23-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-302"><a href="#cb23-302" aria-hidden="true" tabindex="-1"></a>Je veux maintenant faire la somme **par ligne** (donc par infraction) des contentieux, pour voir si certaines infractions appartiennent à plus d'un groupe LCB-FT. </span>
<span id="cb23-303"><a href="#cb23-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-304"><a href="#cb23-304" aria-hidden="true" tabindex="-1"></a>J'ai d'abord utilisé la fonction <span class="in">`dplyr::c_across`</span> pour faire cette opération, après la commande <span class="in">`rowwise()`</span> qui agit un peu comme <span class="in">`group_by`</span> (d'où la nécessité de dégrouper à la fin, sinon toutes les opérations qui suivent se feront par ligne). Ça fonctionne, mais le temps d'exécution est énorme.</span>
<span id="cb23-305"><a href="#cb23-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-306"><a href="#cb23-306" aria-hidden="true" tabindex="-1"></a>La solution (comme prônée sur <span class="co">[</span><span class="ot">cette vignette</span><span class="co">](https://dplyr.tidyverse.org/articles/rowwise.html)</span> du package) est plutôt d'utiliser une fonction déjà programmée qui fait exactement ce que je veux, de base. C'est le cas de <span class="in">`base::rowSums()`</span> que j'ai donc fait passer dans <span class="in">`mutate`</span>, en spécifiant que je ne voulais pas prendre en compte la variable de natinf.</span>
<span id="cb23-307"><a href="#cb23-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-308"><a href="#cb23-308" aria-hidden="true" tabindex="-1"></a>::: {.panel-tabset}</span>
<span id="cb23-309"><a href="#cb23-309" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Seconde tentative - rapide</span></span>
<span id="cb23-312"><a href="#cb23-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-313"><a href="#cb23-313" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-314"><a href="#cb23-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-315"><a href="#cb23-315" aria-hidden="true" tabindex="-1"></a><span class="co"># infractions qui appartiendraient à plusieurs groupes de sous-jacent?</span></span>
<span id="cb23-316"><a href="#cb23-316" aria-hidden="true" tabindex="-1"></a>n_rec <span class="ot">&lt;-</span> n_rec <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">n_sj =</span> <span class="fu">rowSums</span>(<span class="fu">pick</span>(<span class="sc">-</span>natinf)))</span>
<span id="cb23-317"><a href="#cb23-317" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-318"><a href="#cb23-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-319"><a href="#cb23-319" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Première tentative - lent </span></span>
<span id="cb23-322"><a href="#cb23-322" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-323"><a href="#cb23-323" aria-hidden="true" tabindex="-1"></a>n_rec <span class="ot">&lt;-</span> n_rec <span class="sc">%&gt;%</span></span>
<span id="cb23-324"><a href="#cb23-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-325"><a href="#cb23-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_sj =</span> <span class="fu">sum</span>(<span class="fu">c_across</span>(stup<span class="sc">:</span>fiter))) <span class="sc">%&gt;%</span> </span>
<span id="cb23-326"><a href="#cb23-326" aria-hidden="true" tabindex="-1"></a>  ungroup</span>
<span id="cb23-327"><a href="#cb23-327" aria-hidden="true" tabindex="-1"></a>  <span class="co"># très lent</span></span>
<span id="cb23-328"><a href="#cb23-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-329"><a href="#cb23-329" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-330"><a href="#cb23-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-331"><a href="#cb23-331" aria-hidden="true" tabindex="-1"></a>::: {layout-ncol="2"}</span>
<span id="cb23-332"><a href="#cb23-332" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `dplyr`</span></span>
<span id="cb23-335"><a href="#cb23-335" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-336"><a href="#cb23-336" aria-hidden="true" tabindex="-1"></a>n_rec <span class="sc">|&gt;</span> </span>
<span id="cb23-337"><a href="#cb23-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb23-338"><a href="#cb23-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_sj =</span> <span class="fu">sum</span>(<span class="fu">c_across</span>(stup<span class="sc">:</span>fiter))) <span class="sc">|&gt;</span> </span>
<span id="cb23-339"><a href="#cb23-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(n_sj) <span class="co"># LENT!</span></span>
<span id="cb23-340"><a href="#cb23-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-341"><a href="#cb23-341" aria-hidden="true" tabindex="-1"></a><span class="co"># ou plutôt</span></span>
<span id="cb23-342"><a href="#cb23-342" aria-hidden="true" tabindex="-1"></a>n_rec <span class="sc">|&gt;</span> </span>
<span id="cb23-343"><a href="#cb23-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_sj=</span><span class="fu">rowSums</span>(<span class="fu">pick</span>(<span class="sc">-</span>natinf))) <span class="sc">|&gt;</span> </span>
<span id="cb23-344"><a href="#cb23-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(n_sj)</span>
<span id="cb23-345"><a href="#cb23-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-346"><a href="#cb23-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-347"><a href="#cb23-347" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `base`</span></span>
<span id="cb23-350"><a href="#cb23-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-351"><a href="#cb23-351" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">rowSums</span>(n_rec[<span class="sc">-</span><span class="dv">1</span>]))</span>
<span id="cb23-352"><a href="#cb23-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-353"><a href="#cb23-353" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-354"><a href="#cb23-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-357"><a href="#cb23-357" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-358"><a href="#cb23-358" aria-hidden="true" tabindex="-1"></a><span class="co"># quelle est cette natinf qui appartient à trois groupes?</span></span>
<span id="cb23-359"><a href="#cb23-359" aria-hidden="true" tabindex="-1"></a>n_rec[n_rec<span class="sc">$</span>n_sj<span class="sc">==</span><span class="dv">3</span>,]</span>
<span id="cb23-360"><a href="#cb23-360" aria-hidden="true" tabindex="-1"></a>n_rec[<span class="fu">rowSums</span>(n_rec[<span class="sc">-</span><span class="dv">1</span>])<span class="sc">==</span><span class="dv">3</span>,][<span class="dv">1</span>]</span>
<span id="cb23-361"><a href="#cb23-361" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 20307: REALISATION D'UNE OPERATION FINANCIERE ENTRE LA FRANCE ET L'ETRANGER SUR DES FONDS PROVENANT D'INFRACTION A LA LEGISLATION SUR LES STUPEFIANTS : BLANCHIMENT DOUANIER</span></span>
<span id="cb23-362"><a href="#cb23-362" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stup, ffsd, blanchiment</span></span>
<span id="cb23-363"><a href="#cb23-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-364"><a href="#cb23-364" aria-hidden="true" tabindex="-1"></a><span class="co"># combien d'infractions distinctes qui sont bien du blanchiment, et sous-jacent?</span></span>
<span id="cb23-365"><a href="#cb23-365" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(n_rec[n_rec<span class="sc">$</span>n_sj<span class="sc">&gt;</span><span class="dv">0</span>,]) <span class="co"># 1728</span></span>
<span id="cb23-366"><a href="#cb23-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-367"><a href="#cb23-367" aria-hidden="true" tabindex="-1"></a>  <span class="co"># en data.table - clairement moins rapide</span></span>
<span id="cb23-368"><a href="#cb23-368" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(n_rec)[n_sj<span class="sc">&gt;</span><span class="dv">0</span>,.N]</span>
<span id="cb23-369"><a href="#cb23-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-370"><a href="#cb23-370" aria-hidden="true" tabindex="-1"></a><span class="co"># infractions BLANCHIMENT </span></span>
<span id="cb23-371"><a href="#cb23-371" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(n_rec[n_rec<span class="sc">$</span>blanchiment<span class="sc">==</span><span class="dv">1</span>,]) <span class="co"># 75 de blanchiment</span></span>
<span id="cb23-372"><a href="#cb23-372" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(n_rec[n_rec<span class="sc">$</span>blanchiment<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> n_rec<span class="sc">$</span>n_sj<span class="sc">==</span><span class="dv">1</span>,]) <span class="co"># 27 caractérisées comme QUE du blanchiment</span></span>
<span id="cb23-373"><a href="#cb23-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-374"><a href="#cb23-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-375"><a href="#cb23-375" aria-hidden="true" tabindex="-1"></a>::: {layout-ncol="2"}</span>
<span id="cb23-376"><a href="#cb23-376" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `dplyr`</span></span>
<span id="cb23-379"><a href="#cb23-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-380"><a href="#cb23-380" aria-hidden="true" tabindex="-1"></a><span class="co"># contentieux et uniquement ce contentieux</span></span>
<span id="cb23-381"><a href="#cb23-381" aria-hidden="true" tabindex="-1"></a>n_rec <span class="sc">%&gt;%</span> </span>
<span id="cb23-382"><a href="#cb23-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_sj<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-383"><a href="#cb23-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(stup<span class="sc">:</span>fiter,sum)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-384"><a href="#cb23-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb23-385"><a href="#cb23-385" aria-hidden="true" tabindex="-1"></a>    <span class="fu">everything</span>(),</span>
<span id="cb23-386"><a href="#cb23-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"contentieux"</span>,</span>
<span id="cb23-387"><a href="#cb23-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"nb_inf"</span></span>
<span id="cb23-388"><a href="#cb23-388" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-389"><a href="#cb23-389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-390"><a href="#cb23-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-391"><a href="#cb23-391" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `base`</span></span>
<span id="cb23-394"><a href="#cb23-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-395"><a href="#cb23-395" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(n_rec[n_rec<span class="sc">$</span>n_sj<span class="sc">==</span><span class="dv">1</span>,<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">ncol</span>(n_rec))],sum)</span>
<span id="cb23-396"><a href="#cb23-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-397"><a href="#cb23-397" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-398"><a href="#cb23-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-401"><a href="#cb23-401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-402"><a href="#cb23-402" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-403"><a href="#cb23-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-404"><a href="#cb23-404" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">microbenchmark</span>(</span>
<span id="cb23-405"><a href="#cb23-405" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> 50L,</span>
<span id="cb23-406"><a href="#cb23-406" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr =</span> n_rec <span class="sc">|&gt;</span>  </span>
<span id="cb23-407"><a href="#cb23-407" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(n_sj <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-408"><a href="#cb23-408" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(stup<span class="sc">:</span>fiter,sum)) <span class="sc">|&gt;</span>  </span>
<span id="cb23-409"><a href="#cb23-409" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),<span class="at">names_to=</span><span class="st">"contentieux"</span>,<span class="at">values_to=</span><span class="st">"nb_inf"</span>),</span>
<span id="cb23-410"><a href="#cb23-410" aria-hidden="true" tabindex="-1"></a>  <span class="at">base =</span> <span class="fu">sapply</span>(n_rec[n_rec<span class="sc">$</span>n_sj <span class="sc">==</span> <span class="dv">1</span>,<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">ncol</span>(n_rec))],sum)</span>
<span id="cb23-411"><a href="#cb23-411" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb23-412"><a href="#cb23-412" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-413"><a href="#cb23-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-414"><a href="#cb23-414" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pistes d'amélioration</span></span>
</code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>